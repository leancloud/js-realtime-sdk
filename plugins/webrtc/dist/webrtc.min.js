!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leancloud-realtime")):"function"==typeof define&&define.amd?define("webrtc",["exports","leancloud-realtime"],t):t((e=e||self).AV=e.AV||{},e.AV)}(this,(function(e,t){"use strict";var n=function(e){if(Array.isArray(e))return e};var r=function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],r=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(o)throw i}}return n}};var o=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r};var i=function(e,t){if(e){if("string"==typeof e)return o(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}};var a=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var s=function(e,t){return n(e)||r(e,t)||i(e,t)||a()};var c=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e};var u=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t},l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function f(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}var h=f((function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function o(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(e,t,r,i,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var s=new o(r,i||e,a),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],s]:e._events[c].push(s):(e._events[c]=s,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function s(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),s.prototype.eventNames=function(){var e,r,o=[];if(0===this._eventsCount)return o;for(r in e=this._events)t.call(e,r)&&o.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},s.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var o=0,i=r.length,a=new Array(i);o<i;o++)a[o]=r[o].fn;return a},s.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},s.prototype.emit=function(e,t,r,o,i,a){var s=n?n+e:e;if(!this._events[s])return!1;var c,u,l=this._events[s],f=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),f){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,o),!0;case 5:return l.fn.call(l.context,t,r,o,i),!0;case 6:return l.fn.call(l.context,t,r,o,i,a),!0}for(u=1,c=new Array(f-1);u<f;u++)c[u-1]=arguments[u];l.fn.apply(l.context,c)}else{var h,p=l.length;for(u=0;u<p;u++)switch(l[u].once&&this.removeListener(e,l[u].fn,void 0,!0),f){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,t);break;case 3:l[u].fn.call(l[u].context,t,r);break;case 4:l[u].fn.call(l[u].context,t,r,o);break;default:if(!c)for(h=1,c=new Array(f-1);h<f;h++)c[h-1]=arguments[h];l[u].fn.apply(l[u].context,c)}}return!0},s.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},s.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},s.prototype.removeListener=function(e,t,r,o){var i=n?n+e:e;if(!this._events[i])return this;if(!t)return a(this,i),this;var s=this._events[i];if(s.fn)s.fn!==t||o&&!s.once||r&&s.context!==r||a(this,i);else{for(var c=0,u=[],l=s.length;c<l;c++)(s[c].fn!==t||o&&!s[c].once||r&&s[c].context!==r)&&u.push(s[c]);u.length?this._events[i]=1===u.length?u[0]:u:a(this,i)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,e.exports=s}));function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var d=function(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),e},v=f((function(e,t){var n;n={VERSION:"2.4.0",Result:{SUCCEEDED:1,NOTRANSITION:2,CANCELLED:3,PENDING:4},Error:{INVALID_TRANSITION:100,PENDING_TRANSITION:200,INVALID_CALLBACK:300},WILDCARD:"*",ASYNC:"async",create:function(e,t){var r="string"==typeof e.initial?{state:e.initial}:e.initial,o=e.terminal||e.final,i=t||e.target||{},a=e.events||[],s=e.callbacks||{},c={},u={},l=function(e){var t=Array.isArray(e.from)?e.from:e.from?[e.from]:[n.WILDCARD];c[e.name]=c[e.name]||{};for(var r=0;r<t.length;r++)u[t[r]]=u[t[r]]||[],u[t[r]].push(e.name),c[e.name][t[r]]=e.to||t[r];e.to&&(u[e.to]=u[e.to]||[])};r&&(r.event=r.event||"startup",l({name:r.event,from:"none",to:r.state}));for(var f=0;f<a.length;f++)l(a[f]);for(var h in c)c.hasOwnProperty(h)&&(i[h]=n.buildEvent(h,c[h]));for(var h in s)s.hasOwnProperty(h)&&(i[h]=s[h]);return i.current="none",i.is=function(e){return Array.isArray(e)?e.indexOf(this.current)>=0:this.current===e},i.can=function(e){return!this.transition&&void 0!==c[e]&&(c[e].hasOwnProperty(this.current)||c[e].hasOwnProperty(n.WILDCARD))},i.cannot=function(e){return!this.can(e)},i.transitions=function(){return(u[this.current]||[]).concat(u[n.WILDCARD]||[])},i.isFinished=function(){return this.is(o)},i.error=e.error||function(e,t,n,r,o,i,a){throw a||i},i.states=function(){return Object.keys(u).sort()},r&&!r.defer&&i[r.event](),i},doCallback:function(e,t,r,o,i,a){if(t)try{return t.apply(e,[r,o,i].concat(a))}catch(t){return e.error(r,o,i,a,n.Error.INVALID_CALLBACK,"an exception occurred in a caller-provided callback function",t)}},beforeAnyEvent:function(e,t,r,o,i){return n.doCallback(e,e.onbeforeevent,t,r,o,i)},afterAnyEvent:function(e,t,r,o,i){return n.doCallback(e,e.onafterevent||e.onevent,t,r,o,i)},leaveAnyState:function(e,t,r,o,i){return n.doCallback(e,e.onleavestate,t,r,o,i)},enterAnyState:function(e,t,r,o,i){return n.doCallback(e,e.onenterstate||e.onstate,t,r,o,i)},changeState:function(e,t,r,o,i){return n.doCallback(e,e.onchangestate,t,r,o,i)},beforeThisEvent:function(e,t,r,o,i){return n.doCallback(e,e["onbefore"+t],t,r,o,i)},afterThisEvent:function(e,t,r,o,i){return n.doCallback(e,e["onafter"+t]||e["on"+t],t,r,o,i)},leaveThisState:function(e,t,r,o,i){return n.doCallback(e,e["onleave"+r],t,r,o,i)},enterThisState:function(e,t,r,o,i){return n.doCallback(e,e["onenter"+o]||e["on"+o],t,r,o,i)},beforeEvent:function(e,t,r,o,i){if(!1===n.beforeThisEvent(e,t,r,o,i)||!1===n.beforeAnyEvent(e,t,r,o,i))return!1},afterEvent:function(e,t,r,o,i){n.afterThisEvent(e,t,r,o,i),n.afterAnyEvent(e,t,r,o,i)},leaveState:function(e,t,r,o,i){var a=n.leaveThisState(e,t,r,o,i),s=n.leaveAnyState(e,t,r,o,i);return!1!==a&&!1!==s&&(n.ASYNC===a||n.ASYNC===s?n.ASYNC:void 0)},enterState:function(e,t,r,o,i){n.enterThisState(e,t,r,o,i),n.enterAnyState(e,t,r,o,i)},buildEvent:function(e,t){return function(){var r=this.current,o=t[r]||(t[n.WILDCARD]!=n.WILDCARD?t[n.WILDCARD]:r)||r,i=Array.prototype.slice.call(arguments);if(this.transition)return this.error(e,r,o,i,n.Error.PENDING_TRANSITION,"event "+e+" inappropriate because previous transition did not complete");if(this.cannot(e))return this.error(e,r,o,i,n.Error.INVALID_TRANSITION,"event "+e+" inappropriate in current state "+this.current);if(!1===n.beforeEvent(this,e,r,o,i))return n.Result.CANCELLED;if(r===o)return n.afterEvent(this,e,r,o,i),n.Result.NOTRANSITION;var a=this;this.transition=function(){return a.transition=null,a.current=o,n.enterState(a,e,r,o,i),n.changeState(a,e,r,o,i),n.afterEvent(a,e,r,o,i),n.Result.SUCCEEDED},this.transition.cancel=function(){a.transition=null,n.afterEvent(a,e,r,o,i)};var s=n.leaveState(this,e,r,o,i);return!1===s?(this.transition=null,n.Result.CANCELLED):n.ASYNC===s?n.Result.PENDING:this.transition?this.transition():void 0}}},e.exports&&(t=e.exports=n),t.StateMachine=n})),_=(v.StateMachine,f((function(e,t){!function(t){var n=function(){},r=Object.prototype.hasOwnProperty,o=Object.create||function(e){var t=function(){};return t.prototype=e,new t},i=Object.keys||function(e){var t=[];for(var n in e)r.call(e,n)&&t.push(n);return t},a=function(e,t){for(var n in t)r.call(t,n)&&(e[n]=t[n]);return e},s=Object.setPrototypeOf||a,c=Object.prototype.toString,u=Array.isArray||function(e){return"[object Array]"===c.call(e)},l=function(e){return"[object Function]"===c.call(e)},f=!0,h={toString:""};for(var p in h)h.hasOwnProperty(p)&&(f=!1);var d=f?["toString","valueOf"]:null;function v(e,t,r){for(var o,a,s=function(e){var t=i(e);if(f)for(var n,r=0;n=d[r++];)e.hasOwnProperty(n)&&t.push(n);return t}(r),c=0,u=s.length;c<u;)"__self"!==(o=s[c++])&&(a=r[o],l(a)&&(!a.prototype||!a.prototype.__self)&&a.toString().indexOf(".__base")>-1?t[o]=function(r,o){var i=e[r]?e[r]:"__constructor"===r?t.__self.__parent:n,a=function(){var e=this.__base;this.__base=a.__base;var t=o.apply(this,arguments);return this.__base=e,t};return a.__base=i,a}(o,a):t[o]=a)}function _(e,t){for(var n,r=1;n=e[r++];)t?l(n)?y.self(t,n.prototype,n):y.self(t,n):t=l(n)?y(e[0],n.prototype,n):y(e[0],n);return t||e[0]}function y(){var e=arguments,t=u(e[0]),r=t||l(e[0]),i=r?t?_(e[0]):e[0]:n,c=e[r?1:0]||{},f=e[r?2:1],h=c.__constructor||r&&i.prototype&&i.prototype.__constructor?function(){return this.__constructor.apply(this,arguments)}:r?function(){return i.apply(this,arguments)}:function(){};if(!r)return h.prototype=c,h.prototype.__self=h.prototype.constructor=h,a(h,f);s(h,i),h.__parent=i;var p=i.prototype,d=h.prototype=o(p);return d.__self=d.constructor=h,c&&v(p,d,c),f&&v(i,h,f),h}y.self=function(){var e=arguments,t=u(e[0]),n=t?_(e[0],e[0][0]):e[0],r=e[1],o=e[2],i=n.prototype;return r&&v(i,i,r),o&&v(n,n,o),n};var m=!0;e.exports=y,m=!1,"object"==typeof modules&&"function"==typeof modules.define&&(modules.define("inherit",(function(e){e(y)})),m=!1),m&&(t.inherit=y)}(l)})));if(!t.TypedMessage)throw new Error("LeanCloud Realtime SDK not installed");var y,m=_(t.TypedMessage,{__constructor:function(e){this.__base(),this.payload=e}});m.sendOptions={transient:!0},t.messageField("payload")(m);var C,b,g,w,E=t.messageType(-102)(y=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(m))||y,A=t.messageType(-103)(C=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(m))||C,S=t.messageType(-104)(b=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(m))||b,O=t.messageType(-105)(g=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(m))||g,T=function(e){function t(t,n){var r;(r=e.call(this)||this)._setConversation(t),r._peerConnection=r._createPeerConnection(n),r._call=v.create({initial:"calling",events:[{name:"connect",from:"calling",to:"connected"},{name:"close",from:"connected",to:"closed"},{name:"cancel",from:"calling",to:"canceled"},{name:"refuse",from:"calling",to:"refused"}]}),r._promises={};var o=new Promise((function(e){r._promises.resolveStreamReady=e})),i=new Promise((function(e){r._promises.resolveAccept=e}));return Promise.all([o,i]).then((function(e){var t=s(e,1)[0];r._call.can("connect")&&(r._call.connect(),r.emit("connect",t))})),r}u(t,e);var n=t.prototype;return n.close=function(){var e=this;return Promise.resolve().then((function(){e._call.close(),e._destroyPeerConnection(),e._peerConnection.close(),e._destroy()}))},n._handleCloseEvent=function(){this._call.can("close")&&(this.close(),this.emit("close"))},n._setConversation=function(e){this._conversation&&this._conversation.off("message"),e&&(this._conversation=e,e.on("message",this._handleMessage.bind(this)))},n._destroy=function(){this._conversation.off("message")},n._createPeerConnection=function(e){var t=new RTCPeerConnection(e);return t.onicecandidate=this._handleICECandidateEvent.bind(this),t.onaddstream=this._handleAddStreamEvent.bind(this),t.onnremovestream=this._handleRemoveStreamEvent.bind(this),t.oniceconnectionstatechange=this._handleICEConnectionStateChangeEvent.bind(this),t.onsignalingstatechange=this._handleSignalingStateChangeEvent.bind(this),t},n._destroyPeerConnection=function(){var e=this._peerConnection;delete e.onaddstream,delete e.onremovestream,delete e.onnicecandidate,delete e.oniceconnectionstatechange,delete e.onsignalingstatechange},n._handleMessage=function(e){return e instanceof E?this._handleAnswer(e):e instanceof S?this._handleRefusal():e instanceof O?this._handleCancelation():e instanceof A&&this._handleICECandidate(e)},n._handleICECandidate=function(e){var t=new RTCIceCandidate(e.payload);this._peerConnection&&this._peerConnection.addIceCandidate(t).catch(console.error.bind(console))},n._handleICECandidateEvent=function(e){return!(!e.candidate||!this._conversation)&&this._conversation.send(new A(e.candidate)).catch(console.error.bind(console))},n._handleAddStreamEvent=function(e){this._promises.resolveStreamReady(e.stream)},n._handleRemoveStreamEvent=function(){this._handleCloseEvent()},n._handleICEConnectionStateChangeEvent=function(){switch(this._peerConnection.iceConnectionState){case"closed":case"failed":case"disconnected":this._handleCloseEvent()}},n._handleSignalingStateChangeEvent=function(){switch(this._peerConnection.signalingState){case"closed":this._handleCloseEvent()}},n._handleAnswer=function(){throw new Error("not implemented")},n._handleRefusal=function(){throw new Error("not implemented")},n._handleCancelation=function(){throw new Error("not implemented")},d(t,[{key:"state",get:function(){return this._call.current}}]),t}(h),I=function(e){function t(t,n,r){var o;return(o=e.call(this,n,r)||this).to=t,o}u(t,e);var n=t.prototype;return n._handleAnswer=function(e){var t=new RTCSessionDescription(e.payload);this._peerConnection.setRemoteDescription(t),this._promises.resolveAccept()},n._handleRefusal=function(){this._destroyPeerConnection(),this._call.refuse(),this.emit("refuse"),this._destroy()},n.cancel=function(){var e=this;return this._call.cancel(),this._conversation.send(new O).then((function(){return e._destroy()}))},n.close=function(){return this._call.can("cancel")?this.cancel():e.prototype.close.call(this)},t}(T),D=function(e){function t(t,n,r){var o;(o=e.call(this,n,r)||this).from=t.from;var i=new RTCSessionDescription(t.payload);return o._handleOfferPromise=o._peerConnection.setRemoteDescription(i),o}u(t,e);var n=t.prototype;return n.accept=function(e){var t=this;if(!e)throw new TypeError("a MediaStream instance is required to accept a call");return this._handleOfferPromise.then((function(){return t._peerConnection.addStream(e)})).then((function(){return t._peerConnection.createAnswer()})).then((function(e){return t._peerConnection.setLocalDescription(e)})).then((function(){return t._conversation.send(new E(t._peerConnection.localDescription))})).then((function(){return t._promises.resolveAccept()}))},n.refuse=function(){var e=this;return this._conversation.send(new S).then((function(){e._call.refuse(),e._destroy()}))},n._handleCancelation=function(){this._call.cancel(),this.emit("cancel"),this._destroy()},t}(T),R=t.messageType(-101)(w=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(m))||w;function P(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var N={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun3.l.google.com:19302","stun:stun4.l.google.com:19302","stun:stun.ekiga.net","stun:stun.ideasip.com","stun:stun.rixtelecom.se","stun:stun.schlund.de","stun:stun.stunprotocol.org:3478","stun:stun.voiparound.com","stun:stun.voipbuster.com","stun:stun.voipstunt.com","stun:stun.voxgratia.org"]}]},j=function(e){function t(t,n){var r;if("string"!=typeof t)throw new TypeError("id is not a string");return(r=e.call(this)||this).id=t,r.options=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?P(Object(n),!0).forEach((function(t){c(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({RTCConfiguration:N},n),r}u(t,e);var n=t.prototype;return n._open=function(e,t){var n=this;return e.createIMClient(this.id,t,"webrtc").then((function(e){return n._imClient=e,n.id=e.id,e.on("message",(function(e,t){return e instanceof R&&n._handleOffer(e,t)})),e.on("conflict",(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return n.emit.apply(n,["conflict"].concat(t))})),n}))},n.close=function(){return this._imClient.close()},n.call=function(e,t){var n=this;if("string"!=typeof e)throw new TypeError("target id is not a string");if(!t)throw new TypeError("a MediaStream instance is required to make a call");return this._imClient.ping([e]).then((function(r){if(!r.length)throw new Error("Call failed as ".concat(e," is not online"));var o=new I(e,null,n.options.RTCConfiguration),i=new Promise((function(e){o._peerConnection.onnegotiationneeded=e}));return o._peerConnection.addStream(t),i.then((function(){return Promise.all([n._imClient.createConversation({members:[e],unique:!0}),o._peerConnection.createOffer().then((function(e){o._peerConnection.setLocalDescription(e)}))])})).then((function(e){var t=s(e,1)[0];return o._setConversation(t),t.send(new R(o._peerConnection.localDescription))})).then((function(){return o}))}))},n._handleOffer=function(e,t){var n=new D(e,t,this.options.RTCConfiguration);this.emit("call",n)},t}(h),x={name:"leancloud-realtime-plugin-webrtc",messageClasses:[R,E,A,S,O],onRealtimeCreate:function(e){e.createWebRTCClient=function(t,n){return new j(t)._open(e,n)}}},L=!!(window.RTCPeerConnection&&window.RTCSessionDescription&&window.RTCIceCandidate);e.WebRTCPlugin=x,e.isWebRTCSupported=L,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=webrtc.min.js.map
