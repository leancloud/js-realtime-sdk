{"version":3,"file":"groupchat-receipts.min.js","sources":["../../../node_modules/@babel/runtime/helpers/defineProperty.js","../../../node_modules/inherit/lib/inherit.js","../src/realtime.js","../src/read-receipt.js","../src/index.js"],"sourcesContent":["function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nmodule.exports = _defineProperty;","/**\n * @module inherit\n * @version 2.2.7\n * @author Filatov Dmitry <dfilatov@yandex-team.ru>\n * @description This module provides some syntax sugar for \"class\" declarations, constructors, mixins, \"super\" calls and static members.\n */\n\n(function(global) {\n\nvar noop = function() {},\n    hasOwnProperty = Object.prototype.hasOwnProperty,\n    objCreate = Object.create || function(ptp) {\n        var inheritance = function() {};\n        inheritance.prototype = ptp;\n        return new inheritance();\n    },\n    objKeys = Object.keys || function(obj) {\n        var res = [];\n        for(var i in obj) {\n            hasOwnProperty.call(obj, i) && res.push(i);\n        }\n        return res;\n    },\n    extend = function(o1, o2) {\n        for(var i in o2) {\n            hasOwnProperty.call(o2, i) && (o1[i] = o2[i]);\n        }\n\n        return o1;\n    },\n    extendStatic = Object.setPrototypeOf || extend,\n    toStr = Object.prototype.toString,\n    isArray = Array.isArray || function(obj) {\n        return toStr.call(obj) === '[object Array]';\n    },\n    isFunction = function(obj) {\n        return toStr.call(obj) === '[object Function]';\n    },\n    needCheckProps = true,\n    testPropObj = { toString : '' };\n\nfor(var i in testPropObj) { // It's a pity ie hasn't toString, valueOf in for\n    testPropObj.hasOwnProperty(i) && (needCheckProps = false);\n}\n\nvar specProps = needCheckProps? ['toString', 'valueOf'] : null;\n\nfunction getPropList(obj) {\n    var res = objKeys(obj);\n    if(needCheckProps) {\n        var specProp, i = 0;\n        while(specProp = specProps[i++]) {\n            obj.hasOwnProperty(specProp) && res.push(specProp);\n        }\n    }\n\n    return res;\n}\n\nfunction override(base, res, add) {\n    var addList = getPropList(add),\n        j = 0, len = addList.length,\n        name, prop;\n    while(j < len) {\n        if((name = addList[j++]) === '__self') {\n            continue;\n        }\n        prop = add[name];\n        if(isFunction(prop) &&\n                (!prop.prototype || !prop.prototype.__self) && // check to prevent wrapping of \"class\" functions\n                (prop.toString().indexOf('.__base') > -1)) {\n            res[name] = (function(name, prop) {\n                var baseMethod = base[name]?\n                        base[name] :\n                        name === '__constructor'? // case of inheritance from plain function\n                            res.__self.__parent :\n                            noop,\n                    result = function() {\n                        var baseSaved = this.__base;\n\n                        this.__base = result.__base;\n                        var res = prop.apply(this, arguments);\n                        this.__base = baseSaved;\n\n                        return res;\n                    };\n                result.__base = baseMethod;\n\n                return result;\n            })(name, prop);\n        } else {\n            res[name] = prop;\n        }\n    }\n}\n\nfunction applyMixins(mixins, res) {\n    var i = 1, mixin;\n    while(mixin = mixins[i++]) {\n        res?\n            isFunction(mixin)?\n                inherit.self(res, mixin.prototype, mixin) :\n                inherit.self(res, mixin) :\n            res = isFunction(mixin)?\n                inherit(mixins[0], mixin.prototype, mixin) :\n                inherit(mixins[0], mixin);\n    }\n    return res || mixins[0];\n}\n\n/**\n* Creates class\n* @exports\n* @param {Function|Array} [baseClass|baseClassAndMixins] class (or class and mixins) to inherit from\n* @param {Object} prototypeFields\n* @param {Object} [staticFields]\n* @returns {Function} class\n*/\nfunction inherit() {\n    var args = arguments,\n        withMixins = isArray(args[0]),\n        hasBase = withMixins || isFunction(args[0]),\n        base = hasBase? withMixins? applyMixins(args[0]) : args[0] : noop,\n        props = args[hasBase? 1 : 0] || {},\n        staticProps = args[hasBase? 2 : 1],\n        res = props.__constructor || (hasBase && base.prototype && base.prototype.__constructor)?\n            function() {\n                return this.__constructor.apply(this, arguments);\n            } :\n            hasBase?\n                function() {\n                    return base.apply(this, arguments);\n                } :\n                function() {};\n\n    if(!hasBase) {\n        res.prototype = props;\n        res.prototype.__self = res.prototype.constructor = res;\n        return extend(res, staticProps);\n    }\n\n    extendStatic(res, base);\n\n    res.__parent = base;\n\n    var basePtp = base.prototype,\n        resPtp = res.prototype = objCreate(basePtp);\n\n    resPtp.__self = resPtp.constructor = res;\n\n    props && override(basePtp, resPtp, props);\n    staticProps && override(base, res, staticProps);\n\n    return res;\n}\n\ninherit.self = function() {\n    var args = arguments,\n        withMixins = isArray(args[0]),\n        base = withMixins? applyMixins(args[0], args[0][0]) : args[0],\n        props = args[1],\n        staticProps = args[2],\n        basePtp = base.prototype;\n\n    props && override(basePtp, basePtp, props);\n    staticProps && override(base, base, staticProps);\n\n    return base;\n};\n\nvar defineAsGlobal = true;\n/* istanbul ignore next */\nif(typeof exports === 'object') {\n    module.exports = inherit;\n    defineAsGlobal = false;\n}\n/* istanbul ignore next */\nif(typeof modules === 'object' && typeof modules.define === 'function') {\n    modules.define('inherit', function(provide) {\n        provide(inherit);\n    });\n    defineAsGlobal = false;\n}\n/* istanbul ignore next */\nif(typeof define === 'function') {\n    define(function(require, exports, module) {\n        module.exports = inherit;\n    });\n    defineAsGlobal = false;\n}\n/* istanbul ignore next */\ndefineAsGlobal && (global.inherit = inherit);\n\n})(this);\n","/* eslint-disable import/no-unresolved */\nimport { TypedMessage } from 'leancloud-realtime';\n\nif (!TypedMessage) {\n  throw new Error('LeanCloud Realtime SDK not installed');\n}\n\nexport { TypedMessage, messageType, messageField } from 'leancloud-realtime';\n","import inherit from 'inherit';\nimport { messageType, messageField, TypedMessage } from './realtime';\n\nconst ReadReceipt = inherit(TypedMessage, {\n  __constructor(timestamp) {\n    this.__base();\n    this.timestamp = new Date(timestamp);\n  },\n});\nmessageType(-101)(ReadReceipt);\nmessageField(['timestamp'])(ReadReceipt);\nReadReceipt.sendOptions = {\n  transient: true,\n};\n\nexport default ReadReceipt;\n","/** @module leancloud-realtime-plugin-groupchat-receipts */\n\nimport ReadReceipt from './read-receipt';\nimport { name } from '../package.json';\n\n/**\n * @typedef {Object.<String, Date>} GroupchatLastReadTimestamps 对话成员 ID - 最后已读消息时间\n */\n\n/**\n * 群聊已读状态插件。\n * 使用后多人 Conversation 会增加 lastReadTimestamps 属性，该属性是 对话成员 ID - 最后已读消息时间 的键值对。\n * 在首次查询该会话的消息记录后，lastReadTimestamps 将会得到初始值，\n * 之后在该属性有变化时 Conversation 会派发 lastreadtimestampsupdate 事件。\n * @example\n * var realtime = new Realtime({\n *   appId: appId,\n *   appKey: appKey,\n *   server: server,\n *   plugins: [GroupchatReceiptsPlugin],\n * });\n */\nexport const GroupchatReceiptsPlugin = {\n  name,\n  messageClasses: [ReadReceipt],\n  onIMClientCreate: client => {\n    const originalSendReadCommand = client._sendReadCommand;\n    // eslint-disable-next-line no-param-reassign\n    client._sendReadCommand = (conversations, ...args) => {\n      conversations.forEach(conversation => {\n        if (!conversation.transient && conversation.members.length > 2) {\n          conversation\n            .send(new ReadReceipt(conversation.lastMessageAt || new Date()))\n            .catch(error =>\n              console.warn(`Sending groupchat receipt fail: ${error.message}`)\n            );\n        }\n      });\n      return originalSendReadCommand.call(client, conversations, ...args);\n    };\n  },\n  onConversationCreate: conversation => {\n    const originalQueryMessages = conversation.queryMessages;\n    // eslint-disable-next-line no-param-reassign\n    conversation.queryMessages = (...args) => {\n      if (\n        !conversation.transient &&\n        conversation.members.length > 2 &&\n        !conversation.lastReadTimestamps\n      ) {\n        conversation\n          ._fetchAllReceiptTimestamps()\n          .then(maxReadTuple => {\n            // eslint-disable-next-line no-param-reassign\n            conversation.lastReadTimestamps = maxReadTuple.reduce(\n              (result, { pid, lastReadAt }) =>\n                Object.assign(result, { [pid]: lastReadAt }),\n              {}\n            );\n            conversation.emit(\n              'lastreadtimestampsupdate',\n              conversation.lastReadTimestamps\n            );\n          })\n          .catch(error =>\n            console.warn(`Initialize group receipts fail: ${error.message}`)\n          );\n      }\n      return originalQueryMessages.call(conversation, ...args);\n    };\n  },\n  beforeMessageDispatch: (message, conversation) => {\n    if (message.type === ReadReceipt.TYPE) {\n      if (conversation.lastReadTimestamps) {\n        // eslint-disable-next-line no-param-reassign\n        conversation.lastReadTimestamps[message.from] = message.timestamp;\n        /**\n         * 群聊的已读状态更新，由 Conversation 派发\n         * @event lastreadtimestampsupdate\n         * @param {GroupchatLastReadTimestamps} updatedTimestamps 有更新的成员的最后已读消息时间\n         */\n        conversation.emit('lastreadtimestampsupdate', {\n          [message.from]: message.timestamp,\n        });\n      }\n      return false;\n    }\n    return true;\n  },\n};\n\nexport { ReadReceipt };\n"],"names":["obj","key","value","Object","defineProperty","enumerable","configurable","writable","global","noop","hasOwnProperty","prototype","objCreate","create","ptp","inheritance","objKeys","keys","res","i","call","push","extend","o1","o2","extendStatic","setPrototypeOf","toStr","toString","isArray","Array","isFunction","needCheckProps","testPropObj","specProps","override","base","add","name","prop","addList","specProp","getPropList","j","len","length","__self","indexOf","baseMethod","__parent","result","baseSaved","this","__base","apply","arguments","applyMixins","mixins","mixin","inherit","self","args","withMixins","hasBase","props","staticProps","__constructor","constructor","basePtp","resPtp","defineAsGlobal","module","modules","define","provide","TypedMessage","Error","ReadReceipt","timestamp","Date","sendOptions","GroupchatReceiptsPlugin","messageClasses","onIMClientCreate","client","originalSendReadCommand","_sendReadCommand","conversations","forEach","conversation","members","send","lastMessageAt","error","console","warn","message","onConversationCreate","originalQueryMessages","queryMessages","lastReadTimestamps","_fetchAllReceiptTimestamps","then","maxReadTuple","reduce","pid","lastReadAt","assign","emit","beforeMessageDispatch","type","TYPE","from"],"mappings":"qRAeA,MAfA,SAAyBA,EAAKC,EAAKC,GAYjC,OAXID,KAAOD,EACTG,OAAOC,eAAeJ,EAAKC,EAAK,CAC9BC,MAAOA,EACPG,YAAY,EACZC,cAAc,EACdC,UAAU,IAGZP,EAAIC,GAAOC,EAGNF,qYCLT,SAAUQ,GAEV,IAAIC,EAAO,aACPC,EAAiBP,OAAOQ,UAAUD,eAClCE,EAAYT,OAAOU,QAAU,SAASC,GAClC,IAAIC,EAAc,aAElB,OADAA,EAAYJ,UAAYG,EACjB,IAAIC,GAEfC,EAAUb,OAAOc,MAAQ,SAASjB,GAC9B,IAAIkB,EAAM,GACV,IAAI,IAAIC,KAAKnB,EACTU,EAAeU,KAAKpB,EAAKmB,IAAMD,EAAIG,KAAKF,GAE5C,OAAOD,GAEXI,EAAS,SAASC,EAAIC,GAClB,IAAI,IAAIL,KAAKK,EACTd,EAAeU,KAAKI,EAAIL,KAAOI,EAAGJ,GAAKK,EAAGL,IAG9C,OAAOI,GAEXE,EAAetB,OAAOuB,gBAAkBJ,EACxCK,EAAQxB,OAAOQ,UAAUiB,SACzBC,EAAUC,MAAMD,SAAW,SAAS7B,GAChC,MAA2B,mBAApB2B,EAAMP,KAAKpB,IAEtB+B,EAAa,SAAS/B,GAClB,MAA2B,sBAApB2B,EAAMP,KAAKpB,IAEtBgC,GAAiB,EACjBC,EAAc,CAAEL,SAAW,IAE/B,IAAI,IAAIT,KAAKc,EACTA,EAAYvB,eAAeS,KAAOa,GAAiB,GAGvD,IAAIE,EAAYF,EAAgB,CAAC,WAAY,WAAa,KAc1D,SAASG,EAASC,EAAMlB,EAAKmB,GAIzB,IAHA,IAEIC,EAAMC,EAFNC,EAbR,SAAqBxC,GACjB,IAAIkB,EAAMF,EAAQhB,GAClB,GAAGgC,EAEC,IADA,IAAIS,EAAUtB,EAAI,EACZsB,EAAWP,EAAUf,MACvBnB,EAAIU,eAAe+B,IAAavB,EAAIG,KAAKoB,GAIjD,OAAOvB,EAIOwB,CAAYL,GACtBM,EAAI,EAAGC,EAAMJ,EAAQK,OAEnBF,EAAIC,GACuB,YAAzBN,EAAOE,EAAQG,QAGnBJ,EAAOF,EAAIC,GACRP,EAAWQ,MACJA,EAAK5B,YAAc4B,EAAK5B,UAAUmC,SACnCP,EAAKX,WAAWmB,QAAQ,YAAc,EAC3C7B,EAAIoB,GAAQ,SAAUA,EAAMC,GACxB,IAAIS,EAAaZ,EAAKE,GACdF,EAAKE,GACI,kBAATA,EACIpB,EAAI4B,OAAOG,SACXxC,EACRyC,EAAS,WACL,IAAIC,EAAYC,KAAKC,OAErBD,KAAKC,OAASH,EAAOG,OACrB,IAAInC,EAAMqB,EAAKe,MAAMF,KAAMG,WAG3B,OAFAH,KAAKC,OAASF,EAEPjC,GAIf,OAFAgC,EAAOG,OAASL,EAETE,EAjBC,CAkBTZ,EAAMC,GAETrB,EAAIoB,GAAQC,GAKxB,SAASiB,EAAYC,EAAQvC,GAEzB,IADA,IAAWwC,EAAPvC,EAAI,EACFuC,EAAQD,EAAOtC,MACjBD,EACIa,EAAW2B,GACPC,EAAQC,KAAK1C,EAAKwC,EAAM/C,UAAW+C,GACnCC,EAAQC,KAAK1C,EAAKwC,GACtBxC,EAAMa,EAAW2B,GACbC,EAAQF,EAAO,GAAIC,EAAM/C,UAAW+C,GACpCC,EAAQF,EAAO,GAAIC,GAE/B,OAAOxC,GAAOuC,EAAO,GAWzB,SAASE,IACL,IAAIE,EAAON,UACPO,EAAajC,EAAQgC,EAAK,IAC1BE,EAAUD,GAAc/B,EAAW8B,EAAK,IACxCzB,EAAO2B,EAASD,EAAYN,EAAYK,EAAK,IAAMA,EAAK,GAAKpD,EAC7DuD,EAAQH,EAAKE,EAAS,EAAI,IAAM,GAChCE,EAAcJ,EAAKE,EAAS,EAAI,GAChC7C,EAAM8C,EAAME,eAAkBH,GAAW3B,EAAKzB,WAAayB,EAAKzB,UAAUuD,cACtE,WACI,OAAOd,KAAKc,cAAcZ,MAAMF,KAAMG,YAE1CQ,EACI,WACI,OAAO3B,EAAKkB,MAAMF,KAAMG,YAE5B,aAEZ,IAAIQ,EAGA,OAFA7C,EAAIP,UAAYqD,EAChB9C,EAAIP,UAAUmC,OAAS5B,EAAIP,UAAUwD,YAAcjD,EAC5CI,EAAOJ,EAAK+C,GAGvBxC,EAAaP,EAAKkB,GAElBlB,EAAI+B,SAAWb,EAEf,IAAIgC,EAAUhC,EAAKzB,UACf0D,EAASnD,EAAIP,UAAYC,EAAUwD,GAOvC,OALAC,EAAOvB,OAASuB,EAAOF,YAAcjD,EAErC8C,GAAS7B,EAASiC,EAASC,EAAQL,GACnCC,GAAe9B,EAASC,EAAMlB,EAAK+C,GAE5B/C,EAGXyC,EAAQC,KAAO,WACX,IAAIC,EAAON,UACPO,EAAajC,EAAQgC,EAAK,IAC1BzB,EAAO0B,EAAYN,EAAYK,EAAK,GAAIA,EAAK,GAAG,IAAMA,EAAK,GAC3DG,EAAQH,EAAK,GACbI,EAAcJ,EAAK,GACnBO,EAAUhC,EAAKzB,UAKnB,OAHAqD,GAAS7B,EAASiC,EAASA,EAASJ,GACpCC,GAAe9B,EAASC,EAAMA,EAAM6B,GAE7B7B,GAGX,IAAIkC,GAAiB,EAGjBC,UAAiBZ,EACjBW,GAAiB,EAGC,iBAAZE,SAAkD,mBAAnBA,QAAQC,SAC7CD,QAAQC,OAAO,WAAW,SAASC,GAC/BA,EAAQf,MAEZW,GAAiB,GAUrBA,IAAmB9D,EAAOmD,QAAUA,GAxLpC,CA0LGP;;;;;KC9LH,IAAKuB,qBACG,IAAIC,MAAM,wCCDlB,IAAMC,EAAclB,EAAQgB,eAAc,CACxCT,uBAAcY,QACPzB,cACAyB,UAAY,IAAIC,KAAKD,qBAGjB,KAAKD,kBACL,CAAC,cAAcA,GAC5BA,EAAYG,YAAc,YACb,OCUAC,EAA0B,CACrC3C,oDACA4C,eAAgB,CAACL,GACjBM,iBAAkB,SAAAC,OACVC,EAA0BD,EAAOE,iBAEvCF,EAAOE,iBAAmB,SAACC,GACzBA,EAAcC,SAAQ,SAAAC,IACfA,aAA0BA,EAAaC,QAAQ7C,OAAS,GAC3D4C,EACGE,KAAK,IAAId,EAAYY,EAAaG,eAAiB,IAAIb,cACjD,SAAAc,UACLC,QAAQC,+CAAwCF,EAAMG,2CANnBnC,mCAAAA,2BAUpCwB,EAAwBjE,WAAxBiE,GAA6BD,EAAQG,UAAkB1B,MAGlEoC,qBAAsB,SAAAR,OACdS,EAAwBT,EAAaU,cAE3CV,EAAaU,cAAgB,YAExBV,aACDA,EAAaC,QAAQ7C,OAAS,IAC7B4C,EAAaW,oBAEdX,EACGY,6BACAC,MAAK,SAAAC,GAEJd,EAAaW,mBAAqBG,EAAaC,QAC7C,SAACtD,SAAUuD,IAAAA,IAAKC,IAAAA,kBACdvG,OAAOwG,OAAOzD,OAAWuD,EAAMC,MACjC,IAEFjB,EAAamB,KACX,2BACAnB,EAAaW,8BAGV,SAAAP,UACLC,QAAQC,+CAAwCF,EAAMG,wCArB7BnC,2BAAAA,yBAwBxBqC,EAAsB9E,WAAtB8E,GAA2BT,UAAiB5B,MAGvDgD,sBAAuB,SAACb,EAASP,UAC3BO,EAAQc,OAASjC,EAAYkC,OAC3BtB,EAAaW,qBAEfX,EAAaW,mBAAmBJ,EAAQgB,MAAQhB,EAAQlB,UAMxDW,EAAamB,KAAK,gCACfZ,EAAQgB,KAAOhB,EAAQlB,cAGrB"}