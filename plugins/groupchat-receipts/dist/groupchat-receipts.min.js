!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leancloud-realtime")):"function"==typeof define&&define.amd?define("groupchat-receipts",["exports","leancloud-realtime"],t):t((e=e||self).AV=e.AV||{},e.AV)}(this,(function(e,t){"use strict";var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function o(e,t,r){return e(r={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&r.path)}},r.exports),r.exports}var a=o((function(e){function t(r){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports}));n(a);var s=o((function(e){var t=a.default;e.exports=function(e,r){if("object"!==t(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,r||"default");if("object"!==t(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)},e.exports.__esModule=!0,e.exports.default=e.exports}));n(s);var i=o((function(e){var t=a.default;e.exports=function(e){var r=s(e,"string");return"symbol"===t(r)?r:String(r)},e.exports.__esModule=!0,e.exports.default=e.exports}));n(i);var u=n(o((function(e){e.exports=function(e,t,r){return(t=i(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e},e.exports.__esModule=!0,e.exports.default=e.exports}))),p=o((function(e,t){!function(t){var r=function(){},n=Object.prototype.hasOwnProperty,o=Object.create||function(e){var t=function(){};return t.prototype=e,new t},a=Object.keys||function(e){var t=[];for(var r in e)n.call(e,r)&&t.push(r);return t},s=function(e,t){for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e},i=Object.setPrototypeOf||s,u=Object.prototype.toString,p=Array.isArray||function(e){return"[object Array]"===u.call(e)},c=function(e){return"[object Function]"===u.call(e)},l=!0,f={toString:""};for(var d in f)f.hasOwnProperty(d)&&(l=!1);var m=l?["toString","valueOf"]:null;function y(e,t,n){for(var o,s,i=function(e){var t=a(e);if(l)for(var r,n=0;r=m[n++];)e.hasOwnProperty(r)&&t.push(r);return t}(n),u=0,p=i.length;u<p;)"__self"!==(o=i[u++])&&(s=n[o],c(s)&&(!s.prototype||!s.prototype.__self)&&s.toString().indexOf(".__base")>-1?t[o]=function(n,o){var a=e[n]?e[n]:"__constructor"===n?t.__self.__parent:r,s=function(){var e=this.__base;this.__base=s.__base;var t=o.apply(this,arguments);return this.__base=e,t};return s.__base=a,s}(o,s):t[o]=s)}function _(e,t){for(var r,n=1;r=e[n++];)t?c(r)?v.self(t,r.prototype,r):v.self(t,r):t=c(r)?v(e[0],r.prototype,r):v(e[0],r);return t||e[0]}function v(){var e=arguments,t=p(e[0]),n=t||c(e[0]),a=n?t?_(e[0]):e[0]:r,u=e[n?1:0]||{},l=e[n?2:1],f=u.__constructor||n&&a.prototype&&a.prototype.__constructor?function(){return this.__constructor.apply(this,arguments)}:n?function(){return a.apply(this,arguments)}:function(){};if(!n)return f.prototype=u,f.prototype.__self=f.prototype.constructor=f,s(f,l);i(f,a),f.__parent=a;var d=a.prototype,m=f.prototype=o(d);return m.__self=m.constructor=f,u&&y(d,m,u),l&&y(a,f,l),f}v.self=function(){var e=arguments,t=p(e[0]),r=t?_(e[0],e[0][0]):e[0],n=e[1],o=e[2],a=r.prototype;return n&&y(a,a,n),o&&y(r,r,o),r};var b=!0;e.exports=v,b=!1,"object"==typeof modules&&"function"==typeof modules.define&&(modules.define("inherit",(function(e){e(v)})),b=!1),b&&(t.inherit=v)}(r)}));if(!t.TypedMessage)throw new Error("LeanCloud Realtime SDK not installed");var c=p(t.TypedMessage,{__constructor:function(e){this.__base(),this.timestamp=new Date(e)}});t.messageType(-101)(c),t.messageField(["timestamp"])(c),c.sendOptions={transient:!0};var l={name:"leancloud-realtime-plugin-groupchat-receipts",messageClasses:[c],onIMClientCreate:function(e){var t=e._sendReadCommand;e._sendReadCommand=function(r){r.forEach((function(e){!e.transient&&e.members.length>2&&e.send(new c(e.lastMessageAt||new Date)).catch((function(e){return console.warn("Sending groupchat receipt fail: ".concat(e.message))}))}));for(var n=arguments.length,o=new Array(n>1?n-1:0),a=1;a<n;a++)o[a-1]=arguments[a];return t.call.apply(t,[e,r].concat(o))}},onConversationCreate:function(e){var t=e.queryMessages;e.queryMessages=function(){!e.transient&&e.members.length>2&&!e.lastReadTimestamps&&e._fetchAllReceiptTimestamps().then((function(t){e.lastReadTimestamps=t.reduce((function(e,t){var r=t.pid,n=t.lastReadAt;return Object.assign(e,u({},r,n))}),{}),e.emit("lastreadtimestampsupdate",e.lastReadTimestamps)})).catch((function(e){return console.warn("Initialize group receipts fail: ".concat(e.message))}));for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return t.call.apply(t,[e].concat(n))}},beforeMessageDispatch:function(e,t){return e.type!==c.TYPE||(t.lastReadTimestamps&&(t.lastReadTimestamps[e.from]=e.timestamp,t.emit("lastreadtimestampsupdate",u({},e.from,e.timestamp))),!1)}};e.GroupchatReceiptsPlugin=l,e.ReadReceipt=c,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=groupchat-receipts.min.js.map
