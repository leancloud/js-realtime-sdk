!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leancloud-realtime/core")):"function"==typeof define&&define.amd?define("live-query",["exports","leancloud-realtime/core"],t):t((e=e||self).AV=e.AV||{},e.AV)}(this,(function(e,t){"use strict";var n=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r};var r=function(e){if(Array.isArray(e))return n(e)};var i=function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)};var o=function(e,t){if(e){if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}};var a=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var c=function(e){return r(e)||i(e)||o(e)||a()},s=t.Protocols||t.Protocals;if(!s)throw new Error("LeanCloud Realtime SDK not installed");var u=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t},l=s.CommandType,d=s.GenericCommand,f=s.AckCommand,m=function(e){return console.warn(e.message)},p=function(e){function n(n,r,i){var o;return(o=e.call(this)||this)._appId=n,o.id=r,o._connection=i,o._eventemitter=new t.EventEmitter,o._querys=new Set,o}u(n,e);var r=n.prototype;return r._send=function(e){for(var t,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(t=this._connection).send.apply(t,[Object.assign(e,{appId:this._appId,installationId:this.id,service:1})].concat(r))},r._open=function(){return this._send(new d({cmd:l.login}))},r.close=function(){var e=this._eventemitter;return e.emit("beforeclose"),this._send(new d({cmd:l.logout})).then((function(){return e.emit("close")}))},r.register=function(e){this._querys.add(e)},r.deregister=function(e){var t=this;this._querys.delete(e),setTimeout((function(){t._querys.size||t.close().catch(m)}),0)},r._dispatchCommand=function(e){return e.cmd!==l.data?(this.emit("unhandledmessage",e),t.Promise.resolve()):this._dispatchDataCommand(e)},r._dispatchDataCommand=function(e){var t=e.dataMessage,n=t.ids,r=t.msg;this.emit("message",r.map((function(e){var t=e.data;return JSON.parse(t)})));var i=new d({cmd:l.ack,ackMessage:new f({ids:n})});return this._send(i,!1).catch(m)},n}(t.EventEmitter),v={name:"leancloud-realtime-plugin-live-query",onRealtimeCreate:function(e){e._liveQueryClients={},e.createLiveQueryClient=function(n){var r;if(void 0!==e._liveQueryClients[n])return t.Promise.resolve(e._liveQueryClients[n]);var i,o=(r=e._open().then((function(t){var r=new p(e._options.appId,n,t);return t.on("reconnect",(function(){return r._open().then((function(){return r.emit("reconnect")}),(function(e){return r.emit("reconnecterror",e)}))})),r._eventemitter.on("beforeclose",(function(){delete e._liveQueryClients[r.id]}),e),r._eventemitter.on("close",(function(){e._deregister(r)}),e),r._open().then((function(){return e._liveQueryClients[r.id]=r,e._register(r),r}))}))).then.apply(r,c((i=function(){e._deregisterPending&&e._deregisterPending(o)},[function(e){return i(),e},function(e){throw i(),e}])));return e._liveQueryClients[n]=o,e._registerPending&&e._registerPending(o),o}},beforeCommandDispatch:function(e,t){if(!(e.installationId&&1===e.service))return!0;var n=t._liveQueryClients[e.installationId];return n?n._dispatchCommand(e).catch((function(e){return console.warn(e)})):console.warn("Unexpected message received without any live client match: %O",e),!1}};e.LiveQueryPlugin=v,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=live-query.min.js.map
