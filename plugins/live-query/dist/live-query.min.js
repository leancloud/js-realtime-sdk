!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leancloud-realtime/core")):"function"==typeof define&&define.amd?define("live-query",["exports","leancloud-realtime/core"],t):t((e=e||self).AV=e.AV||{},e.AV)}(this,(function(e,t){"use strict";function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function r(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}var o=r((function(e){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r},e.exports.__esModule=!0,e.exports.default=e.exports}));n(o);var i=r((function(e){e.exports=function(e){if(Array.isArray(e))return o(e)},e.exports.__esModule=!0,e.exports.default=e.exports}));n(i);var s=r((function(e){e.exports=function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)},e.exports.__esModule=!0,e.exports.default=e.exports}));n(s);var u=r((function(e){e.exports=function(e,t){if(e){if("string"==typeof e)return o(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}},e.exports.__esModule=!0,e.exports.default=e.exports}));n(u);var a=r((function(e){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.__esModule=!0,e.exports.default=e.exports}));n(a);var c=n(r((function(e){e.exports=function(e){return i(e)||s(e)||u(e)||a()},e.exports.__esModule=!0,e.exports.default=e.exports}))),l=t.Protocols||t.Protocals;if(!l)throw new Error("LeanCloud Realtime SDK not installed");var p=r((function(e){function t(n,r){return e.exports=t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n,r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports}));n(p);var d=n(r((function(e){e.exports=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,p(e,t)},e.exports.__esModule=!0,e.exports.default=e.exports}))),f=l.CommandType,m=l.GenericCommand,_=l.AckCommand,v=function(e){return console.warn(e.message)},y=function(e){function n(n,r,o){var i;return(i=e.call(this)||this)._appId=n,i.id=r,i._connection=o,i._eventemitter=new t.EventEmitter,i._querys=new Set,i}d(n,e);var r=n.prototype;return r._send=function(e){for(var t,n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return(t=this._connection).send.apply(t,[Object.assign(e,{appId:this._appId,installationId:this.id,service:1})].concat(r))},r._open=function(){return this._send(new m({cmd:f.login}))},r.close=function(){var e=this._eventemitter;return e.emit("beforeclose"),this._send(new m({cmd:f.logout})).then((function(){return e.emit("close")}))},r.register=function(e){this._querys.add(e)},r.deregister=function(e){var t=this;this._querys.delete(e),setTimeout((function(){t._querys.size||t.close().catch(v)}),0)},r._dispatchCommand=function(e){return e.cmd!==f.data?(this.emit("unhandledmessage",e),t.Promise.resolve()):this._dispatchDataCommand(e)},r._dispatchDataCommand=function(e){var t=e.dataMessage,n=t.ids,r=t.msg;this.emit("message",r.map((function(e){var t=e.data;return JSON.parse(t)})));var o=new m({cmd:f.ack,ackMessage:new _({ids:n})});return this._send(o,!1).catch(v)},n}(t.EventEmitter),h={name:"leancloud-realtime-plugin-live-query",onRealtimeCreate:function(e){e._liveQueryClients={},e.createLiveQueryClient=function(n){var r;if(void 0!==e._liveQueryClients[n])return t.Promise.resolve(e._liveQueryClients[n]);var o,i=(r=e._open().then((function(t){var r=new y(e._options.appId,n,t);return t.on("reconnect",(function(){return r._open().then((function(){return r.emit("reconnect")}),(function(e){return r.emit("reconnecterror",e)}))})),r._eventemitter.on("beforeclose",(function(){delete e._liveQueryClients[r.id]}),e),r._eventemitter.on("close",(function(){e._deregister(r)}),e),r._open().then((function(){return e._liveQueryClients[r.id]=r,e._register(r),r}))}))).then.apply(r,c((o=function(){e._deregisterPending&&e._deregisterPending(i)},[function(e){return o(),e},function(e){throw o(),e}])));return e._liveQueryClients[n]=i,e._registerPending&&e._registerPending(i),i}},beforeCommandDispatch:function(e,t){if(!(e.installationId&&1===e.service))return!0;var n=t._liveQueryClients[e.installationId];return n?n._dispatchCommand(e).catch((function(e){return console.warn(e)})):console.warn("Unexpected message received without any live client match: %O",e),!1}};e.LiveQueryPlugin=h,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=live-query.min.js.map
