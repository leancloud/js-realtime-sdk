{"version":3,"file":"live-query.min.js","sources":["../../../node_modules/@babel/runtime/helpers/arrayLikeToArray.js","../../../node_modules/@babel/runtime/helpers/arrayWithoutHoles.js","../../../node_modules/@babel/runtime/helpers/iterableToArray.js","../../../node_modules/@babel/runtime/helpers/unsupportedIterableToArray.js","../../../node_modules/@babel/runtime/helpers/nonIterableSpread.js","../../../node_modules/@babel/runtime/helpers/toConsumableArray.js","../src/realtime.js","../../../node_modules/@babel/runtime/helpers/setPrototypeOf.js","../../../node_modules/@babel/runtime/helpers/inheritsLoose.js","../src/live-query-client.js","../src/index.js"],"sourcesContent":["function _arrayLikeToArray(arr, len) {\n  if (len == null || len > arr.length) len = arr.length;\n  for (var i = 0, arr2 = new Array(len); i < len; i++) arr2[i] = arr[i];\n  return arr2;\n}\nmodule.exports = _arrayLikeToArray, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;","var arrayLikeToArray = require(\"./arrayLikeToArray.js\");\nfunction _arrayWithoutHoles(arr) {\n  if (Array.isArray(arr)) return arrayLikeToArray(arr);\n}\nmodule.exports = _arrayWithoutHoles, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;","function _iterableToArray(iter) {\n  if (typeof Symbol !== \"undefined\" && iter[Symbol.iterator] != null || iter[\"@@iterator\"] != null) return Array.from(iter);\n}\nmodule.exports = _iterableToArray, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;","var arrayLikeToArray = require(\"./arrayLikeToArray.js\");\nfunction _unsupportedIterableToArray(o, minLen) {\n  if (!o) return;\n  if (typeof o === \"string\") return arrayLikeToArray(o, minLen);\n  var n = Object.prototype.toString.call(o).slice(8, -1);\n  if (n === \"Object\" && o.constructor) n = o.constructor.name;\n  if (n === \"Map\" || n === \"Set\") return Array.from(o);\n  if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return arrayLikeToArray(o, minLen);\n}\nmodule.exports = _unsupportedIterableToArray, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;","function _nonIterableSpread() {\n  throw new TypeError(\"Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n}\nmodule.exports = _nonIterableSpread, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;","var arrayWithoutHoles = require(\"./arrayWithoutHoles.js\");\nvar iterableToArray = require(\"./iterableToArray.js\");\nvar unsupportedIterableToArray = require(\"./unsupportedIterableToArray.js\");\nvar nonIterableSpread = require(\"./nonIterableSpread.js\");\nfunction _toConsumableArray(arr) {\n  return arrayWithoutHoles(arr) || iterableToArray(arr) || unsupportedIterableToArray(arr) || nonIterableSpread();\n}\nmodule.exports = _toConsumableArray, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;","/* eslint-disable import/no-unresolved */\nimport {\n  Protocols as _Protocols,\n  Protocals,\n  Promise as _Promise,\n} from 'leancloud-realtime/core';\n\nconst Protocols = _Protocols || Protocals;\nif (!Protocols) {\n  throw new Error('LeanCloud Realtime SDK not installed');\n}\nexport { _Promise, Protocols };\n\nexport { EventEmitter } from 'leancloud-realtime/core';\n","function _setPrototypeOf(o, p) {\n  module.exports = _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  }, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;\n  return _setPrototypeOf(o, p);\n}\nmodule.exports = _setPrototypeOf, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;","var setPrototypeOf = require(\"./setPrototypeOf.js\");\nfunction _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n  setPrototypeOf(subClass, superClass);\n}\nmodule.exports = _inheritsLoose, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;","import { Protocols, _Promise, EventEmitter } from './realtime';\n\nconst { CommandType, GenericCommand, AckCommand } = Protocols;\n\nconst warn = error => console.warn(error.message);\n\nexport default class LiveQueryClient extends EventEmitter {\n  constructor(appId, subscriptionId, connection) {\n    super();\n    this._appId = appId;\n    this.id = subscriptionId;\n    this._connection = connection;\n    this._eventemitter = new EventEmitter();\n    this._querys = new Set();\n  }\n\n  _send(cmd, ...args) {\n    return this._connection.send(\n      Object.assign(cmd, {\n        appId: this._appId,\n        installationId: this.id,\n        service: 1,\n      }),\n      ...args\n    );\n  }\n\n  _open() {\n    return this._send(\n      new GenericCommand({\n        cmd: CommandType.login,\n      })\n    );\n  }\n\n  close() {\n    const _ee = this._eventemitter;\n    _ee.emit('beforeclose');\n    return this._send(\n      new GenericCommand({\n        cmd: CommandType.logout,\n      })\n    ).then(() => _ee.emit('close'));\n  }\n\n  register(liveQuery) {\n    this._querys.add(liveQuery);\n  }\n\n  deregister(liveQuery) {\n    this._querys.delete(liveQuery);\n    setTimeout(() => {\n      if (!this._querys.size) this.close().catch(warn);\n    }, 0);\n  }\n\n  _dispatchCommand(command) {\n    if (command.cmd !== CommandType.data) {\n      this.emit('unhandledmessage', command);\n      return _Promise.resolve();\n    }\n    return this._dispatchDataCommand(command);\n  }\n\n  _dispatchDataCommand({ dataMessage: { ids, msg } }) {\n    this.emit(\n      'message',\n      msg.map(({ data }) => JSON.parse(data))\n    );\n    // send ack\n    const command = new GenericCommand({\n      cmd: CommandType.ack,\n      ackMessage: new AckCommand({\n        ids,\n      }),\n    });\n    return this._send(command, false).catch(warn);\n  }\n}\n","import { _Promise } from './realtime';\nimport LiveQueryClient from './live-query-client';\n\nconst finalize = callback => [\n  // eslint-disable-next-line no-sequences\n  value => (callback(), value),\n  error => {\n    callback();\n    throw error;\n  },\n];\n\nconst onRealtimeCreate = realtime => {\n  /* eslint-disable no-param-reassign */\n  realtime._liveQueryClients = {};\n  realtime.createLiveQueryClient = subscriptionId => {\n    if (realtime._liveQueryClients[subscriptionId] !== undefined) {\n      return _Promise.resolve(realtime._liveQueryClients[subscriptionId]);\n    }\n    const promise = realtime\n      ._open()\n      .then(connection => {\n        const client = new LiveQueryClient(\n          realtime._options.appId,\n          subscriptionId,\n          connection\n        );\n        connection.on('reconnect', () =>\n          client\n            ._open()\n            .then(\n              () => client.emit('reconnect'),\n              error => client.emit('reconnecterror', error)\n            )\n        );\n        client._eventemitter.on(\n          'beforeclose',\n          () => {\n            delete realtime._liveQueryClients[client.id];\n          },\n          realtime\n        );\n        client._eventemitter.on(\n          'close',\n          () => {\n            realtime._deregister(client);\n          },\n          realtime\n        );\n        return client._open().then(() => {\n          realtime._liveQueryClients[client.id] = client;\n          realtime._register(client);\n          return client;\n        });\n      })\n      .then(\n        ...finalize(() => {\n          if (realtime._deregisterPending) realtime._deregisterPending(promise);\n        })\n      );\n    realtime._liveQueryClients[subscriptionId] = promise;\n    if (realtime._registerPending) realtime._registerPending(promise);\n    return promise;\n  };\n  /* eslint-enable no-param-reassign */\n};\n\nconst beforeCommandDispatch = (command, realtime) => {\n  const isLiveQueryCommand = command.installationId && command.service === 1;\n  if (!isLiveQueryCommand) return true;\n  const targetClient = realtime._liveQueryClients[command.installationId];\n  if (targetClient) {\n    targetClient._dispatchCommand(command).catch(error => console.warn(error));\n  } else {\n    console.warn(\n      'Unexpected message received without any live client match: %O',\n      command\n    );\n  }\n  return false;\n};\n\n// eslint-disable-next-line import/prefer-default-export\nexport const LiveQueryPlugin = {\n  name: 'leancloud-realtime-plugin-live-query',\n  onRealtimeCreate,\n  beforeCommandDispatch,\n};\n"],"names":["module","arr","len","length","i","arr2","Array","exports","isArray","arrayLikeToArray","iter","Symbol","iterator","from","o","minLen","n","Object","prototype","toString","call","slice","constructor","name","test","TypeError","arrayWithoutHoles","iterableToArray","unsupportedIterableToArray","nonIterableSpread","Protocols","_Protocols","Protocals","Error","_setPrototypeOf","p","setPrototypeOf","bind","__proto__","subClass","superClass","create","CommandType","GenericCommand","AckCommand","warn","error","console","message","LiveQueryClient","_EventEmitter","appId","subscriptionId","connection","_this","_appId","id","_connection","_eventemitter","EventEmitter","_querys","Set","_inheritsLoose","_proto","_send","cmd","_this$_connection","_len","arguments","args","_key","send","apply","assign","this","installationId","service","concat","_open","login","close","_ee","emit","logout","then","register","liveQuery","add","deregister","_this2","setTimeout","size","_dispatchCommand","command","data","_Promise","resolve","_dispatchDataCommand","_ref","_ref$dataMessage","dataMessage","ids","msg","map","_ref2","JSON","parse","ack","ackMessage","LiveQueryPlugin","onRealtimeCreate","realtime","_liveQueryClients","createLiveQueryClient","_realtime$_open$then","undefined","callback","promise","client","_options","on","_deregister","_register","_toConsumableArray","_deregisterPending","value","_registerPending","beforeCommandDispatch","targetClient"],"mappings":"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"}